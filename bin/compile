#!/bin/bash

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

log() {
  echo "-----> ELM: $1"
}

mkdir -p "$1" "$2" "$3"
mkdir -p .platform_tools/elm/bin
build_path=$(cd "$1/" && pwd)
cache_path=$(cd "$2/" && pwd)
env_path=$(cd "$3/" && pwd)

function write_profile_d_script() {
  log "Creating .profile.d with env vars"
  mkdir -p $build_path/.profile.d

  touch "$build_path/.profile.d/elm_buildpack_paths.sh"
  log "PATH: $PATH"
  "export \$HOME/.elm/bin:\$PATH" >> "$build_path/.profile.d/elm_buildpack_paths.sh"
  "export LC_CTYPE=en_US.utf8" >> "$build_path/.profile.d/elm_buildpack_paths.sh""
}

log "Downloading"
curl -L -o "$cache_path/elm.gz" https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
log "Gunzipping"
gunzip "$cache_path/elm.gz"
log "Make executable"
chmod +x "$cache_path/elm"

mkdir -p "$build_path/.elm/bin"
log "Copy"
cp "$cache_path/elm" "$build_path/.elm/bin/"
write_profile_d_script
