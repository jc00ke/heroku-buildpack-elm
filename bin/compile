#!/bin/bash

# Notes
# https://github.com/MaxwellBo/heroku-buildpack-elm/blob/master/bin/compile
# https://github.com/HashNuke/heroku-buildpack-elixir/blob/master/bin/compile

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

log_section() {
  echo "-----> ELM: $1"
}

log() {
  echo "-----> ELM: $1"
}

mkdir -p "$1" "$2" "$3"
readonly build_path=$(cd "$1/" && pwd)
readonly cache_path=$(cd "$2/" && pwd)
readonly bp_path=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

function write_profile_d_script() {
  log "Creating .profile.d with env vars"
  mkdir -p "$build_path/.profile.d"

  echo "export PATH=\"/app/.elm:\$PATH\"" >> "$build_path/.profile.d/elm.sh"
}

write_export() {
  local bp_dir="$1"
  local build_dir="$2"
  echo "export PATH=\"$build_dir/.elm:\$PATH\"" > $bp_dir/export
}

if ! test -f "$cache_path/elm.gz"; then
  log "Downloading"
  curl -L -o "$cache_path/elm.gz" "https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz"
fi
log "Gunzipping"
gunzip "$cache_path/elm.gz"
log "Make executable"
chmod +x "$cache_path/elm"

mkdir -p "$build_path/.elm"
log "Copy"
cp "$cache_path/elm" "$build_path/.elm/"
write_profile_d_script
write_export "$bp_path" "$build_path"
