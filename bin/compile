#!/bin/bash

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

log() {
  echo "-----> $1"
}

mkdir -p "$1" "$2" "$3"
mkdir -p .platform_tools/elm/bin
build_path=$(cd "$1/" && pwd)
cache_path=$(cd "$2/" && pwd)
env_path=$(cd "$3/" && pwd)

function write_profile_d_script() {
  output_section "Creating .profile.d with env vars"
  mkdir -p $build_path/.profile.d

  local export_line="export PATH=\$HOME/.platform_tools:\$HOME/.platform_tools/elm/bin:\$PATH
                     export LC_CTYPE=en_US.utf8"


  echo $export_line >> $build_path/.profile.d/elm_buildpack_paths.sh
}

curl -L -o "$cache_path/elm.gz" https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
gunzip "$cache_path/elm.gz"
chmod +x "$cache_path/elm"

cp "$cache_path/elm" ".platform_tools/elm/bin/"
write_profile_d_script
